{% extends 'base.html' %}

{% block title %}Play - YCulture{% endblock %}

{% block content %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'play/css/play.css' %}">

    <div class="game">
        <div id="questions">
            <h2>{{ question.0 }}</h2>
            <div id="timer" aria-live="assertive" role="timer"><span id="countdown"></span></div>
            <form id="response-form" method="post" action="{% url 'play' %}">
                {% csrf_token %}
                <div id="response">
                    <ul>
                        <li>
                            <button type="submit" class="response-button" name="selected_answer_id" value="{{ response.0.0.id }}" aria-label="{{ response.0.0 }}" role="button">{{ response.0.0 }}</button>
                        </li>
                        <li>
                            <button type="submit" class="response-button" name="selected_answer_id" value="{{ response.0.1.id }}" aria-label="{{ response.0.1 }}" role="button">{{ response.0.1 }}</button>
                        </li>
                        <li>
                            <button type="submit" class="response-button" name="selected_answer_id" value="{{ response.0.2.id }}" aria-label="{{ response.0.2 }}" role="button">{{ response.0.2 }}</button>
                        </li>
                        <li>
                            <button type="submit" class="response-button" name="selected_answer_id" value="{{ response.0.3.id }}" aria-label="{{ response.0.3 }}" role="button">{{ response.0.3 }}</button>
                        </li>
                    </ul>
                </div>
            </form>
        </div>
    </div>
    <script src="{% static 'play/js/script.js' %}"></script>

    <script>
        function updateTimer(){
            let countdownElement = document.getElementById("countdown")
            let seconds = 30
            function countdown(){
                seconds--
                let minutes = Math.floor(seconds / 60)
                let remainingSeconds = seconds % 60
                countdownElement.textContent = minutes + ":" + (remainingSeconds < 10 ? "0" : "") + remainingSeconds
                if(seconds <= 0){
                    console.log("la")
                    clearInterval(timer)
                    countdownElement.textContent = "0:00"
                    window.location.reload();

                }
            }
            countdown()
            let timer = setInterval(countdown, 1000)
        }

        function handleResponseButtonClick() {
            var buttons = document.querySelectorAll('.response-button')
            buttons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    var selectedAnswer = button.value
                    console.log('Selected answer:', selectedAnswer)

                    var formData = new FormData()
                    formData.append('selected_answer', selectedAnswer)
                    
                    fetch('/play/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log('Réponse enregistrée avec succès')
                            // Actualiser la page après avoir envoyé la réponse
                            location.reload();
                        } else {
                            console.error('Erreur lors de l\'enregistrement de la réponse')
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de l\'envoi des données:', error)
                    })
                })
            })
        }
        updateTimer()
        handleResponseButtonClick();
    </script>
{% endblock %}
